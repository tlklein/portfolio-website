name: "SBOM Generation and Vulnerability Scans"

on:
  push:
    branches:
      - main
      - dev
      - feature
  pull_request:
    branches:
      - main
      - dev
      - feature
  schedule:
    - cron: '0 0 1 * *'  # Monthly

permissions:
  contents: read
  security-events: write

jobs:
  sbom-scan:
    name: SBOM + OSV Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      #################################################################
      # Pin Go version â‰¥1.24.9
      #################################################################
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.9'

      - name: Show Go version
        run: go version

      #################################################################
      # Ensure vulnerable modules are replaced and all dependencies updated
      #################################################################
      - name: Patch known vulnerable modules and update dependencies
        shell: bash
        run: |
          set -euo pipefail
          echo "Processing all go.mod files in repo..."
          find . -name go.mod -print | while read -r gm; do
            dir=$(dirname "$gm")
            echo "--- Processing $gm ---"
            pushd "$dir" >/dev/null || continue

            # Inject replacements for known vulnerable modules
            go mod edit -replace=github.com/opencontainers/selinux=github.com/opencontainers/selinux@v1.13.0
            go mod edit -replace=github.com/containerd/containerd=github.com/containerd/containerd@v1.7.29

            # Explicitly fetch patched modules, even if not directly imported
            go get github.com/opencontainers/selinux@v1.13.0 || true
            go get github.com/containerd/containerd@v1.7.29 || true

            # Update all other dependencies (direct + indirect)
            go get -u ./... || true
            go mod tidy

            # Show relevant module versions
            go list -m all | grep -E 'selinux|containerd' || echo "No matching modules in $dir"

            popd >/dev/null
          done
          echo "Module replacements applied and all dependencies updated."

      #################################################################
      # Generate SBOM using Syft
      #################################################################
      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | bash -s -- -b /usr/local/bin
          syft version

      - name: Generate SBOM
        run: |
          echo "Generating SBOM..."
          syft packages
