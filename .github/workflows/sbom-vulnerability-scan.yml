name: "SBOM Generation & Vulnerability Scan"

# Trigger on pushes, pull requests, and monthly schedule
on:
  push:
    branches:
      - main
      - dev
      - feature
  pull_request:
    branches:
      - main
      - dev
      - feature
  schedule:
    - cron: '0 0 1 * *' # 1st of every month, 00:00 UTC

permissions:
  contents: read
  security-events: write

jobs:
  #################################################################
  # SBOM generation + Grype + OSV scanning (with Go module patching)
  #################################################################
  vulnerability-scan:
    name: SBOM + Grype + OSV Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      # --------------------------
      # Set up Go
      # --------------------------
      - name: Set up Go 1.24.9
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.9'

      - name: Show Go version
        run: go version

      # --------------------------
      # Install Syft and Grype
      # --------------------------
      - name: Install Syft and Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | bash -s -- -b /usr/local/bin
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | bash -s -- -b /usr/local/bin
          syft version
          grype version

      # --------------------------
      # Patch vulnerable Go modules
      # --------------------------
      - name: Patch vulnerable Go modules and update all dependencies
        shell: bash
        run: |
          set -euo pipefail
          echo "Processing all go.mod files for module patching..."
          find . -name go.mod -print | while read -r gm; do
            dir=$(dirname "$gm")
            echo "--- Processing $gm ---"
            pushd "$dir" >/dev/null || continue

            # Inject replacement lines for known vulnerable modules
            go mod edit -replace=github.com/opencontainers/selinux=github.com/opencontainers/selinux@v1.13.0
            go mod edit -replace=github.com/containerd/containerd=github.com/containerd/containerd@v1.7.29

            # Update all direct and indirect dependencies
            go get -u all
            go mod tidy

            # Show patched versions
            go list -m all | grep -E 'selinux|containerd' || echo "No selinux/containerd found in $dir"

            popd >/dev/null
          done
          echo "All modules patched and updated successfully."

      # --------------------------
      # Generate valid JSON SBOM
      # --------------------------
      - name: Generate SBOM
        run: |
          echo "Generating SBOM in JSON format..."
          syft packages . -o json > sbom.json
          if ! jq empty sbom.json; then
            echo "Error: sbom.json is not valid JSON"
            exit 1
          fi
          echo "SBOM successfully generated and validated."

      # --------------------------
      # Grype scan (fail only on SBOM)
      # --------------------------
      - name: Scan SBOM with Grype
        run: |
          echo "Scanning SBOM with Grype..."
          grype sbom:./sbom.json -o table || true
          CRIT_HIGH_SBOM=$(grype sbom:./sbom.json -o json | jq '[.matches[] | select(.vulnerability.severity=="Critical" or .vulnerability.severity=="High")] | length')
          echo "SBOM Critical/High count: $CRIT_HIGH_SBOM"

          if [ "$CRIT_HIGH_SBOM" -gt 0 ]; then
            echo "CRITICAL/HIGH vulnerabilities detected in SBOM ($CRIT_HIGH_SBOM). Failing the job."
            grype sbom:./sbom.json -o json | jq -r '.matches[] | select(.vulnerability.severity=="Critical" or .vulnerability.severity=="High") | "SBOM: \(.artifact.name) \(.artifact.version) -> \(.vulnerability.id) \(.vulnerability.severity)"'
            exit 1
          else
            echo "No Critical/High vulnerabilities in SBOM."
          fi

      # --------------------------
      # Optional: OSV API check
      # --------------------------
      - name: OSV API vulnerability check
        run: |
          echo "Running OSV API vulnerability scan..."
          FOUND=0
          cat sbom.json | jq -c '.artifacts[] | {name: .name, version: .version}' | while read -r pkg; do
            NAME=$(echo "$pkg" | jq -r '.name')
            VERSION=$(echo "$pkg" | jq -r '.version')
            if [ -z "$NAME" ] || [ -z "$VERSION" ]; then
              continue
            fi
            RESPONSE=$(curl -s -X POST "https://api.osv.dev/v1/query" \
              -H "Content-Type: application/json" \
              -d "{\"package\": {\"name\": \"$NAME\"}, \"version\": \"$VERSION\"}")
            if echo "$RESPONSE" | jq -e '.vulns' | grep -q '.'; then
              echo "Vulnerabilities found in $NAME@$VERSION"
              echo "$RESPONSE" | jq -r '.vulns[] | "â€¢ \(.id): \(.summary)"'
              FOUND=1
            fi
          done
          if [ "$FOUND" = "1" ]; then
            echo "Vulnerabilities detected by OSV (informational only)."
          else
            echo "No vulnerabilities detected by OSV."
          fi
