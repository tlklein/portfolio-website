name: "Site Quality Checks"

# Trigger on pushes, pull requests, and monthly schedule
on:
  push:
    branches:
      - main
      - dev
      - feature
  pull_request:
    branches:
      - main
      - dev
      - feature
  schedule:
    - cron: '0 0 1 * *'  # 1st of every month, 00:00 UTC

permissions:
  contents: read
  security-events: write

jobs:
  #################################################################
  # Enforce signed commits
  #################################################################
  verify-signatures:
    name: Verify commit signatures
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Verify signed commits
        run: |
          echo "Verifying GPG-signed commits..."
          git fetch origin main || true
          git log --pretty=format:'%h %G? %s' origin/main..HEAD | while read commit g status msg; do
            if [ "$g" != "G" ]; then
              echo "Commit $commit is not GPG-signed: $msg"
              exit 1
            fi
          done
          echo "All commits are properly signed."

  #################################################################
  # CodeQL security analysis
  #################################################################
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    needs: verify-signatures
    steps:
      - uses: actions/checkout@v5
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript,python
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "security"
          output: results.sarif
      - name: Fail on high severity issues
        run: |
          if grep -q '"level": "error"' results.sarif; then
            echo "High severity CodeQL issues detected!"
            exit 1
          else
            echo "No high severity CodeQL findings."
          fi

  #################################################################
  # SBOM generation + Grype + OSV scanning (only fail on SBOM)
  #################################################################
  vulnerability-scan:
    name: SBOM + Grype + OSV Scanning (fail only on SBOM results)
    runs-on: ubuntu-latest
    needs: verify-signatures
    steps:
      - uses: actions/checkout@v5

      #################################################################
      # Pin Go and cache modules
      #################################################################
      - name: Set up Go 1.24.9
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.9'
          cache: true

      - name: Show Go version
        run: go version

      #################################################################
      # Ensure module 'go' directive is >= 1.24 to avoid stdlib CVEs
      #################################################################
      - name: Ensure all go.mod files declare go 1.24
        shell: bash
        run: |
          set -euo pipefail
          echo "Updating 'go' directive in all go.mod files to '1.24'..."
          find . -name go.mod -print | while read -r gm; do
            dir=$(dirname "$gm")
            echo "=== $gm (dir=$dir) ==="
            pushd "$dir" >/dev/null || continue
            go mod edit -go=1.24 || echo "go mod edit -go=1.24 failed in $dir"
            go mod tidy || echo "go mod tidy warning in $dir"
            echo "go.mod in $dir now contains: $(grep '^go ' go.mod || true)"
            popd >/dev/null
          done

      #################################################################
      # Inject patched module replacements and upgrade dependencies
      #################################################################
      - name: Inject replacements + upgrade transitive dependencies
        shell: bash
        run: |
          set -euo pipefail
          echo "Injecting replace directives and upgrading dependencies..."
          find . -name go.mod -print | while read -r gm; do
            dir=$(dirname "$gm")
            echo "--- Processing $gm ---"
            pushd "$dir" >/dev/null || continue

            # Force patched versions (safe, targeted replacements)
            go mod edit -replace=github.com/opencontainers/selinux@v1.12.0=github.com/opencontainers/selinux@v1.13.0 || true
            go mod edit -replace=github.com/containerd/containerd@v1.7.28=github.com/containerd/containerd@v1.7.29 || true

            # Upgrade direct + indirect dependencies (use -u=patch if you want patch-only)
            echo "Upgrading dependencies (may take a moment)..."
            go get -u ./... || echo "go get -u failed in $dir (continuing)"
            go mod tidy || echo "go mod tidy failed in $dir (continuing)"

            echo "Top modules (sample):"
            go list -m all | head -n 20 || true

            popd >/dev/null
          done

      #################################################################
      # Install Syft, Grype and jq
      #################################################################
      - name: Install Syft, Grype and jq
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | bash -s -- -b /usr/local/bin
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | bash -s -- -b /usr/local/bin
          sudo apt-get update -y
          sudo apt-get install -y jq
          syft version
          grype version
          jq --version

      #################################################################
      # Generate SBOM
      #################################################################
      - name: Generate SBOM with Syft (full JSON)
        run: |
          echo "Generating Syft SBOM (full JSON)..."
          syft . -o json > sbom.json
          echo "SBOM generated: $(wc -c sbom.json) bytes"

      #################################################################
      # Run Grype: SBOM and filesystem scans 
      #################################################################
      - name: Run Grype scans and only fail on SBOM Critical/High
        shell: bash
        run: |
          set -euo pipefail
          echo "Scanning SBOM with Grype (sbom:./sbom.json)"
          grype sbom:./sbom.json -o table || true

          echo
          echo "Scanning filesystem with Grype (.) — results are informational only"
          grype . -o table || true

          echo
          echo "Checking SBOM-based results for Critical/High..."
          CRIT_HIGH_SBOM=$(grype sbom:./sbom.json -o json | jq '[.matches[] | select(.vulnerability.severity=="Critical" or .vulnerability.severity=="High")] | length')
          echo "SBOM Critical/High count: $CRIT_HIGH_SBOM"

          echo "Checking filesystem-based results (informational) for Critical/High..."
          CRIT_HIGH_FS=$(grype . -o json | jq '[.matches[] | select(.vulnerability.severity=="Critical" or .vulnerability.severity=="High")] | length')
          echo "Filesystem Critical/High count: $CRIT_HIGH_FS (informational only)"

          if [ "$CRIT_HIGH_SBOM" -gt 0 ]; then
            echo "CRITICAL/HIGH vulnerabilities detected in SBOM ($CRIT_HIGH_SBOM). Failing the job."
            grype sbom:./sbom.json -o json | jq -r '.matches[] | select(.vulnerability.severity=="Critical" or .vulnerability.severity=="High") | "SBOM: \(.artifact.name) \(.artifact.version) -> \(.vulnerability.id) \(.vulnerability.severity)"' || true
            exit 1
          else
            echo "No Critical/High vulnerabilities in SBOM. Continuing despite filesystem findings (informational)."
            if [ "$CRIT_HIGH_FS" -gt 0 ]; then
              echo "WARNING: filesystem scan found Critical/High entries (informational only):"
              grype . -o json | jq -r '.matches[] | select(.vulnerability.severity=="Critical" or .vulnerability.severity=="High") | "FS: \(.artifact.name) \(.artifact.version) -> \(.vulnerability.id) \(.vulnerability.severity)"' || true
            fi
          fi

      #################################################################
      # OSV API scan
      #################################################################
      - name: Run OSV API vulnerability check
        shell: bash
        run: |
          set -euo pipefail
          echo "Running OSV API vulnerability scan..."
          FOUND=0
          jq -c '.artifacts[] | {name: .name, version: .version}' sbom.json | while read -r pkg; do
            NAME=$(echo "$pkg" | jq -r '.name')
            VERSION=$(echo "$pkg" | jq -r '.version')
            if [ -z "$NAME" ] || [ -z "$VERSION" ]; then
              continue
            fi
            RESPONSE=$(curl -s -X POST "https://api.osv.dev/v1/query" \
              -H "Content-Type: application/json" \
              -d "{\"package\": {\"name\": \"$NAME\"}, \"version\": \"$VERSION\"}")
            if echo "$RESPONSE" | jq -e '.vulns' >/dev/null 2>&1; then
              echo "Vulnerabilities found in $NAME@$VERSION (OSV):"
              echo "$RESPONSE" | jq -r '.vulns[] | "• \(.id): \(.summary // \"(no summary)\")"'
              FOUND=1
            fi
          done
          if [ "$FOUND" -eq 1 ]; then
            echo "Vulnerabilities detected by OSV. Failing job."
            exit 1
          else
            echo "No vulnerabilities detected by OSV."
          fi
